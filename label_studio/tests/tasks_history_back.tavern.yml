---
test_name: postpone_submit
strict: false
marks:
- usefixtures:
  - django_live_url
stages:
- id: signup
  type: ref
- id: create_project
  type: ref

- &create_first_task
  name: create_task
  request:
    json:
      data:
        text: 'Test text'
      project: '{project_pk}'
    method: POST
    url: '{django_live_url}/api/tasks'
  response:
    save:
      json:
        first_task_pk: id
    status_code: 201
- &create_second_task
  name: create_task
  request:
    json:
      data:
        text: 'Test text'
      project: '{project_pk}'
    method: POST
    url: '{django_live_url}/api/tasks'
  response:
    save:
      json:
        second_task_pk: id
    status_code: 201
- &create_third_task
  name: create_task
  request:
    json:
      data:
        text: 'Test text'
      project: '{project_pk}'
    method: POST
    url: '{django_live_url}/api/tasks'
  response:
    save:
      json:
        third_task_pk: id
    status_code: 201

- &postpone_task_first
  name: postpone_first_task
  request:
    method: POST
    url: '{django_live_url}/api/tasks/{first_task_pk}/drafts'
    json:
      was_postponed: true
      project: '{project_pk}'
      result: []
  response:
    status_code: 201
    save:
      json:
        first_draft_pk: id
    json:
      task: !int '{first_task_pk}'

- &get_next_task_second
  name: get_next_task
  request:
    method: GET
    url: '{django_live_url}/api/projects/{project_pk}/next'
  response:
    json:
      id: !int '{second_task_pk}'

- &create_annotation_second_task
  name: create_annotation_second_task
  request:
    headers:
      content-type: application/json
    json:
      lead_time: 12.34
      result:
      - from_name: label
        to_name: text
        type: choices
        value:
          choices:
          - pos
    method: POST
    url: '{django_live_url}/api/tasks/{second_task_pk}/annotations'
  response:
    save:
      json:
        annotation_pk: id
        annotation_created_at: created_at
    status_code: 201

- &get_next_task_third
  name: get_next_task
  request:
    method: GET
    url: '{django_live_url}/api/projects/{project_pk}/next'
  response:
    json:
      id: !int '{third_task_pk}'

- &get_previous_task_no_anno_or_draft_for3
  name: get_previous_task_no_anno_or_draft_for3
  request:
    method: GET
    url: '{django_live_url}/api/projects/{project_pk}/previous-task/?task={third_task_pk}'
  response:
    status_code: 200
    json:
      - previous:
          task: !int "{second_task_pk}"
          annotation: !int "{annotation_pk}"
          created_at: "{annotation_created_at}"
        next: null

- &get_previous_task_no_anno_or_draft_for2
  name: get_previous_task_no_anno_or_draft_for2
  request:
    method: GET
    url: '{django_live_url}/api/projects/{project_pk}/previous-task/?task={second_task_pk}&annotation={annotation_pk}'
  response:
    status_code: 200
    json:
      - previous:
          task: !int "{first_task_pk}"
          draft: !int "{first_draft_pk}"
        next: null

- &create_annotation_first_task
  name: create_annotation_first_task
  request:
    headers:
      content-type: application/json
    json:
      lead_time: 12.34
      result:
      - from_name: label
        to_name: text
        type: choices
        value:
          choices:
          - pos
    method: POST
    url: '{django_live_url}/api/tasks/{first_task_pk}/annotations'
  response:
    save:
      json:
        second_annotation_pk: id
        second_annotation_created_at: created_at
    status_code: 201

- name: get_previous_task_no_anno_or_draft_for3
  request:
    method: GET
    url: '{django_live_url}/api/projects/{project_pk}/previous-task/?task={third_task_pk}'
  response:
    status_code: 200
    json:
      - previous:
          task: !int "{first_task_pk}"
          annotation: !int "{second_annotation_pk}"
          created_at: "{second_annotation_created_at}"
        next: null

---
test_name: postpone_skip
strict: false
marks:
- usefixtures:
  - django_live_url
stages:
- id: signup
  type: ref
- id: create_project
  type: ref

- *create_first_task
- *create_second_task
- *create_third_task
- *postpone_task_first
- *get_next_task_second

- &create_skip_annotation_second_task
  name: create_skip_annotation_second_task
  request:
    headers:
      content-type: application/json
    json:
      was_postponed: true
      result: []
    method: POST
    url: '{django_live_url}/api/tasks/{second_task_pk}/annotations'
  response:
    save:
      json:
        annotation_pk: id
        annotation_created_at: created_at
    status_code: 201

- *get_next_task_third

- *get_previous_task_no_anno_or_draft_for3

- *get_previous_task_no_anno_or_draft_for2

- &unskip_task
  name: unskip_task
  request:
    headers:
      content-type: application/json
    method: POST
    url: '{django_live_url}/api/annotations/{annotation_pk}/convert-to-draft?project={project_pk}'
  response:
    save:
      json:
        second_draft_pk: id
        second_draft_created_at: created_at
    status_code: 201

- &get_previous_task_with_draft_for3
  name: get_previous_task_no_anno_or_draft_for3
  request:
    method: GET
    url: '{django_live_url}/api/projects/{project_pk}/previous-task/?task={third_task_pk}'
  response:
    status_code: 200
    json:
      - previous:
          task: !int "{second_task_pk}"
          draft: !int "{second_draft_pk}"
          created_at: "{second_draft_created_at}"
        next: null

---
test_name: postpone_skip_submit
strict: false
marks:
- usefixtures:
  - django_live_url
stages:
- id: signup
  type: ref
- id: create_project
  type: ref

- *create_first_task
- *create_second_task
- *create_third_task
- *postpone_task_first
- *get_next_task_second
- *create_skip_annotation_second_task
- *get_next_task_third
- *get_previous_task_no_anno_or_draft_for3
- *get_previous_task_no_anno_or_draft_for2
- *unskip_task
- *get_previous_task_with_draft_for3
- name: create_annotation_second_task_from_draft
  request:
    headers:
      content-type: application/json
    json:
      draft_id: !int "{second_draft_pk}"
      result: []
      project: !int '{project_pk}'
    method: POST
    url: '{django_live_url}/api/tasks/{second_task_pk}/annotations'
  response:
    save:
      json:
        annotation_pk_from_draft: id
        annotation_created_at_from_draft: created_at
    status_code: 201
- *get_next_task_third
- name: get_previous_task_no_anno_or_draft_for2
  request:
    method: GET
    url: '{django_live_url}/api/projects/{project_pk}/previous-task/?task={second_task_pk}&annotation={annotation_pk_from_draft}'
  response:
    status_code: 200
    json:
      - previous:
          task: !int "{first_task_pk}"
          draft: !int "{first_draft_pk}"
        next: null

---
test_name: submit_submit_patch
strict: false
marks:
- usefixtures:
  - django_live_url
stages:
- id: signup
  type: ref
- id: create_project
  type: ref

- *create_first_task
- *create_second_task
- *create_third_task
- &submit_task_first
  name: submit_first_task
  request:
    method: POST
    url: '{django_live_url}/api/tasks/{first_task_pk}/annotations'
    json:
      project: '{project_pk}'
      result: []
  response:
    status_code: 201
    save:
      json:
        first_annotation_pk: id
        first_annotation_created_at: created_at
    json:
      task: !int '{first_task_pk}'
- *get_next_task_second
- &create_fourth_task
  name: create_task
  request:
    json:
      data:
        text: 'Test text'
      project: '{project_pk}'
    method: POST
    url: '{django_live_url}/api/tasks'
  response:
    save:
      json:
        fourth_task_pk: id
    status_code: 201
- *create_annotation_second_task
- *get_next_task_third
- *get_previous_task_no_anno_or_draft_for3
- name: get_previous_task_no_anno_or_draft_for2
  request:
    method: GET
    url: '{django_live_url}/api/projects/{project_pk}/previous-task/?task={second_task_pk}&annotation={annotation_pk}'
  response:
    status_code: 200
    json:
      - previous:
          task: !int "{first_task_pk}"
          annotation: !int "{first_annotation_pk}"
        next: null